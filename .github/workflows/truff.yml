name: Secret Scanning

on:
  push:
    branches:
      - master

jobs:
  scan:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v2

    - name: Install X server
      run: |
        sudo apt-get update
        sudo apt-get install xorg openbox


    - name: Run X server
      run: |
        systemctl start xorg.service

    - name: Run truffleHog
      run: |
        python3 -m venv env
        source env/bin/activate
        python -m pip install truffleHog
        python env/bin/trufflehog --json https://github.com/youngowl13/pepper.git > truffleHog.json || true
        ls 
        pwd
        
        
    - name: Run detect-secrets
      run: |
        python3 -m venv env-ds
        source env-ds/bin/activate
        pip install detect-secrets
        detect-secrets scan > detect-secrets.json
        ls
        pwd
      
 


    - name: Parse truffleHog results
      run: |
        import json
        import csv

        with open('truffleHog.json', 'r') as f:
            data = json.load(f)

        # Create a CSV writer object
        with open('csv_file.csv', 'w', newline='') as csvfile:
            writer = csv.writer(csvfile, delimiter=',')

            # Write the header row
            writer.writerow(['Secret Type', 'File', 'Hashed Secret', 'Line Number'])

            # Write the data rows
            for secret in data['results']:
                for key, value in secret.items():
                    if key == 'type':
                        secret_type = value
                    elif key == 'filename':
                        filename = value
                    elif key == 'hashed_secret':
                        hashed_secret = value
                    elif key == 'line_number':
                        line_number = value

                writer.writerow([secret_type, filename, hashed_secret, line_number])

    - name: Upload csv as artifact
      uses: actions/upload-artifact@v2
      with:
        name: csv-file
        path: csv_file.csv
